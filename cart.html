<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Your Cart</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header>
      <nav>
        <ul class="tabs">
          <li class="store-name">Channa Stores</li>
          <li><a href="products.html" class="tab">Products</a></li>
          <li><a href="cart.html" class="tab active">Cart</a></li>
          <li><a href="orders.html" class="tab">Orders</a></li>
          <li><a href="profile.html" class="tab">Profile</a></li>
          <li class="signout-tab">
            <a href="login.html" class="tab">Sign Out</a>
          </li>
        </ul>
      </nav>
    </header>

    <main>
      <h2>Your Cart</h2>

      <!-- Cart Table -->
      <section id="cart-section">
        <table id="cart-table">
          <thead>
            <tr>
              <th>Product</th>
              <th>Quantity</th>
              <th>Price</th>
              <th>Total</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Dynamically populated cart items will go here -->
          </tbody>
        </table>
        <p id="total-price">Total: Rs. 0.00</p>
        <button id="checkout-button">Checkout</button>
      </section>
    </main>

    <footer>
      <p>&copy; 2024 Shop Management System</p>
    </footer>

    <script>
      // Sample cart data (this would usually be dynamically populated from local storage or a backend)
      //   let cart = [
      //     { id: 1, name: "Product 1", price: 10.0, quantity: 2 },
      //     { id: 2, name: "Product 2", price: 15.0, quantity: 1 },
      //   ];

      // Function to render the cart
      function renderCart() {
        const cartTableBody = document.querySelector("#cart-table tbody");
        cartTableBody.innerHTML = "";
        let totalPrice = 0;
        // const user_id = localStorage.getItem("user_id");
        const user_id = 1;
        let cart = [];
        fetch(`http://localhost:8080/api/cart/${user_id}/items`, {
          method: "GET",
        })
          .then((response) => response.json())
          .then((data) => {
            console.log(data);
            cart = data;
            cart.forEach((item) => {
              console.log(item);
              const row = document.createElement("tr");
              const totalItemPrice = item.price * item.quantity;
              totalPrice += totalItemPrice;
              console.log(item);
              row.innerHTML = `
                        <td>${item.productName}</td>
                        <td>
                            <input type="number" value="${
                              item.quantity
                            }" min="0" id="quantity-${
                item.id
              }" onchange="updateQuantity(${item.id})">
                        </td>
                        <td>Rs.${item.price.toFixed(2)}</td>
                        <td>Rs.${totalItemPrice.toFixed(2)}</td>
                        <td><button onclick="removeFromCart(${
                          item.id
                        })">Remove</button></td>
                    `;
              cartTableBody.appendChild(row);

              document.getElementById(
                "total-price"
              ).textContent = `Total: Rs. ${totalPrice.toFixed(2)}`;
            });
          })
          .catch((error) => {
            console.error("Error fetching cart items:", error);
            alert("Failed to fetch cart items. Please try again!");
          });
        fetch(`http://localhost:8080/api/cart/userId/${user_id}`, {
          method: "GET",
        })
          .then((response) => response.json())
          .then((data) => {
            const cartId = data;
            localStorage.setItem("cartId", cartId);
          })
          .catch((error) => {
            console.error("Error fetching cart ID:", error);
            alert("Failed to fetch cart ID. Please try again!");
          });
      }
      //////////////////////////////////////////////////////////////////////////////////////////////////////////////////
      function updateQuantity(cartId, productId) {
        const quantityInput = document.getElementById(`quantity-${productId}`);
        const newQuantity = parseInt(quantityInput.value);

        // Validate quantity
        if (isNaN(newQuantity) || newQuantity < 0) {
          alert("Please enter a valid non-negative number for quantity!");
          return;
        }

        // Update the quantity in the local cart
        const product = cart.find((item) => item.id === productId);
        if (!product) {
          console.error(`Product with ID ${productId} not found in the cart.`);
          return;
        }
        product.quantity = newQuantity;

        // Update the backend with the new quantity
        updateCartQuantityInBackend(cartId, productId, newQuantity);

        // Re-render the cart
        renderCart();
      }

      function updateCartQuantityInBackend(cartId, productId, newQuantity) {
        fetch(`/api/cart/${cartId}/items/${productId}`, {
          method: "PUT", // Use PUT or PATCH depending on your API design
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ quantity: newQuantity }),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`Server error: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            console.log("Cart updated successfully:", data);
            renderCart();
          })
          .catch((error) => {
            console.error("Error updating cart:", error);
            alert("Failed to update cart. Please try again!");
          });
      }

      /////////////////////////////////////////////////////////////////////////////////////////////////////////////////
      // Function to remove a product from the cart
      function removeFromCart(productId) {
        // Remove the item from the cart based on its ID
        const cartId = localStorage.getItem("cartId");
        fetch(`http://localhost:8080/api/cart/${cartId}/items/${productId}`, {
          method: "DELETE",
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("Item removed from cart:", data);
          });
        cart = cart.filter((item) => item.id !== productId);

        // Re-render the cart to reflect changes
        renderCart();
      }
      ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
      // Checkout functionality
      document
        .getElementById("checkout-button")
        .addEventListener("click", function () {
          if (cart.length === 0) {
            alert("Your cart is empty!");
            return;
          }

          // Process the order (you can replace this with API calls)
          alert("Order placed successfully!");
          cart = []; // Empty the cart after checkout
          renderCart(); // Re-render the cart
        });
      ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
      // Initial render of the cart
      renderCart();
    </script>
  </body>
</html>
